/*
 * File:        ColReorderWithResize.js
 * Version:     1.0.7
 * CVS:         $Id$
 * Description: Allow columns to be reordered in a DataTable
 * Author:      Allan Jardine (www.sprymedia.co.uk)
 * Author:      Christophe Battarel (www.altairis.fr)
 * Created:     Wed Sep 15 18:23:29 BST 2010
 * Modified:    July 2011 by Christophe Battarel - christophe.battarel@altairis.fr (columns resizable)
 * Modified:    February 2012 by Martin Marchetta - martin.marchetta@gmail.com
 *  1. Made the "hot area" for resizing a little wider (it was a little difficult to hit the exact border of a column for resizing)
 *  2. Resizing didn't work at all when using scroller (that plugin splits the table into 2 different tables: one for the header and another one for the body, so when you resized the header, the data columns didn't follow)
 *  3. Fixed collateral effects of sorting feature
 *  4. If sScrollX is enabled (i.e. horizontal scrolling), when resizing a column the width of the other columns is not changed, but the whole
 *     table is resized to give an Excel-like behavior (good suggestion by Allan)
 * Modified:    February 2012 by Christophe Battarel - christophe.battarel@altairis.fr (ColReorder v1.0.5 adaptation)
 * Modified:    September 16th 2012 by Hassan Kamara - h@phrmc.com
 * Language:    Javascript
 * License:     GPL v2 or BSD 3 point style
 * Project:     DataTables
 * Contact:     www.sprymedia.co.uk/contact
 * 
 * Copyright 2010-2011 Allan Jardine, all rights reserved.
 *
 * This source file is free software, under either the GPL v2 license or a
 * BSD style license, available at:
 *   http://datatables.net/license_gpl2
 *   http://datatables.net/license_bsd
 *
 */

(function(d,q,h){function n(a){for(var c=[],d=0,b=a.length;d<b;d++)c[a[d]]=d;return c}function l(a,c,d){c=a.splice(c,1)[0];a.splice(d,0,c)}function p(a,c,d){for(var b=[],f=0,g=a.childNodes.length;f<g;f++)1==a.childNodes[f].nodeType&&b.push(a.childNodes[f]);c=b[c];null!==d?a.insertBefore(c,b[d]):a.appendChild(c)}d.fn.dataTableExt.oApi.fnColReorder=function(a,c,e){var b,f,g,m,h=a.aoColumns.length,j;if(c!=e)if(0>c||c>=h)this.oApi._fnLog(a,1,"ColReorder 'from' index is out of bounds: "+c);else if(0>e|| e>=h)this.oApi._fnLog(a,1,"ColReorder 'to' index is out of bounds: "+e);else{var k=[];b=0;for(f=h;b<f;b++)k[b]=b;l(k,c,e);k=n(k);b=0;for(f=a.aaSorting.length;b<f;b++)a.aaSorting[b][0]=k[a.aaSorting[b][0]];if(null!==a.aaSortingFixed){b=0;for(f=a.aaSortingFixed.length;b<f;b++)a.aaSortingFixed[b][0]=k[a.aaSortingFixed[b][0]]}b=0;for(f=h;b<f;b++){j=a.aoColumns[b];g=0;for(m=j.aDataSort.length;g<m;g++)j.aDataSort[g]=k[j.aDataSort[g]]}b=0;for(f=h;b<f;b++)j=a.aoColumns[b],"number"==typeof j.mData&&(j.mData= k[j.mData],j.fnGetData=a.oApi._fnGetObjectDataFn(j.mData),j.fnSetData=a.oApi._fnSetObjectDataFn(j.mData));if(a.aoColumns[c].bVisible){m=this.oApi._fnColumnIndexToVisible(a,c);j=null;for(b=e<c?e:e+1;null===j&&b<h;)j=this.oApi._fnColumnIndexToVisible(a,b),b++;g=a.nTHead.getElementsByTagName("tr");b=0;for(f=g.length;b<f;b++)p(g[b],m,j);if(null!==a.nTFoot){g=a.nTFoot.getElementsByTagName("tr");b=0;for(f=g.length;b<f;b++)p(g[b],m,j)}b=0;for(f=a.aoData.length;b<f;b++)null!==a.aoData[b].nTr&&p(a.aoData[b].nTr, m,j)}l(a.aoColumns,c,e);l(a.aoPreSearchCols,c,e);b=0;for(f=a.aoData.length;b<f;b++)d.isArray(a.aoData[b]._aData)&&l(a.aoData[b]._aData,c,e),l(a.aoData[b]._anHidden,c,e);b=0;for(f=a.aoHeader.length;b<f;b++)l(a.aoHeader[b],c,e);if(null!==a.aoFooter){b=0;for(f=a.aoFooter.length;b<f;b++)l(a.aoFooter[b],c,e)}b=0;for(f=h;b<f;b++)a.aoColumns[b].aDataSort=[b],a.aoColumns[b]._ColReorder_iOrigCol=b,d(a.aoColumns[b].nTh).unbind("click"),this.oApi._fnSortAttachListener(a,a.aoColumns[b].nTh,b);"undefined"!=typeof ColVis&& ColVis.fnRebuild(a.oInstance);d(a.oInstance).trigger("column-reorder",[a,{iFrom:c,iTo:e,aiInvertMapping:k}]);"undefined"!=typeof a.oInstance._oPluginFixedHeader&&a.oInstance._oPluginFixedHeader.fnUpdate()}};ColReorder=function(a,c){(!this.CLASS||"ColReorder"!=this.CLASS)&&alert("Warning: ColReorder must be initialised with the keyword 'new'");"undefined"==typeof c&&(c={});this.s={dt:null,init:c,allowReorder:!0,allowResize:!0,fixed:0,dropCallback:null,mouse:{startX:-1,startY:-1,offsetX:-1,offsetY:-1, target:-1,targetIndex:-1,fromIndex:-1},aoTargets:[]};this.dom={drag:null,resize:null,pointer:null};this.table_size=-1;this.s.dt=a.oInstance.fnSettings();this._fnConstruct();a.oApi._fnCallbackReg(a,"aoDestroyCallback",jQuery.proxy(this._fnDestroy,this),"ColReorder");ColReorder.aoInstances.push(this);return this};ColReorder.prototype={fnReset:function(){for(var a=[],c=0,d=this.s.dt.aoColumns.length;c<d;c++)a.push(this.s.dt.aoColumns[c]._ColReorder_iOrigCol);this._fnOrderColumns(a)},_fnConstruct:function(){var a= this,c,d;"undefined"!=typeof this.s.init.allowReorder&&(this.s.allowReorder=this.s.init.allowReorder);"undefined"!=typeof this.s.init.allowResize&&(this.s.allowResize=this.s.init.allowResize);"undefined"!=typeof this.s.init.iFixedColumns&&(this.s.fixed=this.s.init.iFixedColumns);"undefined"!=typeof this.s.init.fnReorderCallback&&(this.s.dropCallback=this.s.init.fnReorderCallback);c=0;for(d=this.s.dt.aoColumns.length;c<d;c++)c>this.s.fixed-1&&this._fnMouseListener(c,this.s.dt.aoColumns[c].nTh),this.s.dt.aoColumns[c]._ColReorder_iOrigCol= c;this.s.dt.oApi._fnCallbackReg(this.s.dt,"aoStateSaveParams",function(b,c){a._fnStateSave.call(a,c)},"ColReorder_State");var b=null;"undefined"!=typeof this.s.init.aiOrder&&(b=this.s.init.aiOrder.slice());this.s.dt.oLoadedState&&("undefined"!=typeof this.s.dt.oLoadedState.ColReorder&&this.s.dt.oLoadedState.ColReorder.length==this.s.dt.aoColumns.length)&&(b=this.s.dt.oLoadedState.ColReorder);if(b)if(a.s.dt._bInitComplete)c=n(b),a._fnOrderColumns.call(a,c);else{var f=!1;this.s.dt.aoDrawCallback.push({fn:function(){if(!a.s.dt._bInitComplete&& !f){f=!0;var c=n(b);a._fnOrderColumns.call(a,c)}},sName:"ColReorder_Pre"})}},_fnOrderColumns:function(a){if(a.length!=this.s.dt.aoColumns.length)this.s.dt.oInstance.oApi._fnLog(oDTSettings,1,"ColReorder - array reorder does not match known number of columns. Skipping.");else{for(var c=0,e=a.length;c<e;c++){var b=d.inArray(c,a);c!=b&&(l(a,b,c),this.s.dt.oInstance.fnColReorder(b,c))}(""!==this.s.dt.oScroll.sX||""!==this.s.dt.oScroll.sY)&&this.s.dt.oInstance.fnAdjustColumnSizing();this.s.dt.oInstance.oApi._fnSaveState(this.s.dt)}}, _fnStateSave:function(a){var c,e,b,f=this.s.dt;for(c=0;c<a.aaSorting.length;c++)a.aaSorting[c][0]=f.aoColumns[a.aaSorting[c][0]]._ColReorder_iOrigCol;aSearchCopy=d.extend(!0,[],a.aoSearchCols);a.ColReorder=[];c=0;for(e=f.aoColumns.length;c<e;c++)b=f.aoColumns[c]._ColReorder_iOrigCol,a.aoSearchCols[b]=aSearchCopy[c],a.abVisCols[b]=f.aoColumns[c].bVisible,a.ColReorder.push(b)},_fnMouseListener:function(a,c){var e=this;d(c).unbind("mousemove.ColReorder");d(c).unbind("mousedown.ColReorder");this.s.allowResize&& d(c).bind("mousemove.ColReorder",function(a){if(null===e.dom.drag&&null===e.dom.resize){var c="TH"==a.target.nodeName?a.target:d(a.target).parents("TH")[0],g=d(c).offset(),h=d(c).innerWidth();5>=Math.abs(a.pageX-Math.round(g.left+h))?d(c).css({cursor:"col-resize"}):d(c).css({cursor:"pointer"})}});d(c).bind("mousedown.ColReorder",function(b){e._fnMouseDown.call(e,b,c,a);return!1})},_fnMouseDown:function(a,c,e){var b=this,f=this.s.dt.aoColumns;if("col-resize"==d(c).css("cursor"))this.s.mouse.startX= a.pageX,this.s.mouse.startWidth=d(c).width(),this.s.mouse.resizeElem=d(c),f=d(c).next(),this.s.mouse.nextStartWidth=d(f).width(),b.dom.resize=!0,this.s.dt.aoColumns[e].bSortable=!1,this.s.dt.oFeatures.bAutoWidth=!1;else if(this.s.allowReorder){b.dom.resize=null;var g="TH"==a.target.nodeName?a.target:d(a.target).parents("TH")[0],g=d(g).offset();this.s.mouse.startX=a.pageX;this.s.mouse.startY=a.pageY;this.s.mouse.offsetX=a.pageX-g.left;this.s.mouse.offsetY=a.pageY-g.top;this.s.mouse.target=c;this.s.mouse.targetIndex= d("th",c.parentNode).index(c);this.s.mouse.fromIndex=this.s.dt.oInstance.oApi._fnVisibleToColumnIndex(this.s.dt,this.s.mouse.targetIndex);this.s.aoTargets.splice(0,this.s.aoTargets.length);this.s.aoTargets.push({x:d(this.s.dt.nTable).offset().left,to:0});e=a=0;for(c=f.length;e<c;e++)e!=this.s.mouse.fromIndex&&a++,f[e].bVisible&&this.s.aoTargets.push({x:d(f[e].nTh).offset().left+d(f[e].nTh).outerWidth(),to:a});0!==this.s.fixed&&this.s.aoTargets.splice(0,this.s.fixed)}d(h).bind("mousemove.ColReorder", function(a){b._fnMouseMove.call(b,a,e)});d(h).bind("mouseup.ColReorder",function(a){setTimeout(function(){b._fnMouseUp.call(b,a,e)},10)})},_fnMouseMove:function(a,c){var e;e=""===this.s.dt.oInit.sScrollX?!1:!0;0>this.table_size&&(e&&void 0!=d("div.dataTables_scrollHead",this.s.dt.nTableWrapper))&&0<d("div.dataTables_scrollHead",this.s.dt.nTableWrapper).length&&(this.table_size=d(d("div.dataTables_scrollHead",this.s.dt.nTableWrapper)[0].childNodes[0].childNodes[0]).width());if(this.dom.resize){var b= this.s.mouse.resizeElem,f=d(b).next(),g=a.pageX-this.s.mouse.startX;0!=g&&!e&&d(f).width(this.s.mouse.nextStartWidth-g);d(b).width(this.s.mouse.startWidth+g);e&&void 0!=d("div.dataTables_scrollHead",this.s.dt.nTableWrapper)&&0<d("div.dataTables_scrollHead",this.s.dt.nTableWrapper).length&&d(d("div.dataTables_scrollHead",this.s.dt.nTableWrapper)[0].childNodes[0].childNodes[0]).width(this.table_size+g);if(null!=d("div.dataTables_scrollBody")&&0<d("div.dataTables_scrollBody").length){for(f=b=-1;f<this.s.dt.aoColumns.length- 1&&f!=c;f++)this.s.dt.aoColumns[f+1].bVisible&&b++;tableScroller=d("div.dataTables_scrollBody",this.s.dt.nTableWrapper)[0];scrollingTableHead=d(tableScroller)[0].childNodes[0].childNodes[0].childNodes[0];0!=g&&!e&&d(d(scrollingTableHead)[0].childNodes[b+1]).width(this.s.mouse.nextStartWidth-g);d(d(scrollingTableHead)[0].childNodes[b]).width(this.s.mouse.startWidth+g);e&&d(d(tableScroller)[0].childNodes[0]).width(this.table_size+g)}}else if(this.s.allowReorder){if(null===this.dom.drag){if(5>Math.pow(Math.pow(a.pageX- this.s.mouse.startX,2)+Math.pow(a.pageY-this.s.mouse.startY,2),0.5))return;this._fnCreateDragNode()}this.dom.drag.style.left=a.pageX-this.s.mouse.offsetX+"px";this.dom.drag.style.top=a.pageY-this.s.mouse.offsetY+"px";e=!1;g=1;for(b=this.s.aoTargets.length;g<b;g++)if(a.pageX<this.s.aoTargets[g-1].x+(this.s.aoTargets[g].x-this.s.aoTargets[g-1].x)/2){this.dom.pointer.style.left=this.s.aoTargets[g-1].x+"px";this.s.mouse.toIndex=this.s.aoTargets[g-1].to;e=!0;break}e||(this.dom.pointer.style.left=this.s.aoTargets[this.s.aoTargets.length- 1].x+"px",this.s.mouse.toIndex=this.s.aoTargets[this.s.aoTargets.length-1].to)}},_fnMouseUp:function(a,c){d(h).unbind("mousemove.ColReorder");d(h).unbind("mouseup.ColReorder");if(null!==this.dom.drag)h.body.removeChild(this.dom.drag),h.body.removeChild(this.dom.pointer),this.dom.drag=null,this.dom.pointer=null,this.s.dt.oInstance.fnColReorder(this.s.mouse.fromIndex,this.s.mouse.toIndex),(""!==this.s.dt.oScroll.sX||""!==this.s.dt.oScroll.sY)&&this.s.dt.oInstance.fnAdjustColumnSizing(),null!==this.s.dropCallback&& this.s.dropCallback.call(this),this._fnConstruct(),this.s.dt.oInstance.oApi._fnSaveState(this.s.dt);else if(null!==this.dom.resize){var e,b,f;this.s.dt.aoColumns[c].bSortable=!0;this.s.dt.aoColumns[c].sWidth=d(this.s.mouse.resizeElem).innerWidth()+"px";f=""===this.s.dt.oInit.sScrollX?!1:!0;if(!f){for(b=c+1;b<this.s.dt.aoColumns.length&&!this.s.dt.aoColumns[b].bVisible;b++);for(e=c-1;0<=e&&!this.s.dt.aoColumns[e].bVisible;e--);if(this.s.dt.aoColumns.length>b)this.s.dt.aoColumns[b].sWidth=d(this.s.mouse.resizeElem).next().innerWidth()+ "px";else for(b=this.s.mouse.resizeElem;0<e;e--)this.s.dt.aoColumns[e].bVisible&&(b=d(b).prev(),this.s.dt.aoColumns[e].sWidth=d(b).innerWidth()+"px")}f&&void 0!=d("div.dataTables_scrollHead",this.s.dt.nTableWrapper)&&0<d("div.dataTables_scrollHead",this.s.dt.nTableWrapper).length&&(this.table_size=d(d("div.dataTables_scrollHead",this.s.dt.nTableWrapper)[0].childNodes[0].childNodes[0]).width());this.s.dt.oInstance.oApi._fnSaveState(this.s.dt)}this.dom.resize=null},_fnCreateDragNode:function(){var a= this;this.dom.drag=d(this.s.dt.nTHead.parentNode).clone(!0)[0];for(this.dom.drag.className+=" DTCR_clonedTable";0<this.dom.drag.getElementsByTagName("caption").length;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("caption")[0]);for(;0<this.dom.drag.getElementsByTagName("tbody").length;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("tbody")[0]);for(;0<this.dom.drag.getElementsByTagName("tfoot").length;)this.dom.drag.removeChild(this.dom.drag.getElementsByTagName("tfoot")[0]); d("thead tr:eq(0)",this.dom.drag).each(function(){d("th:not(:eq("+a.s.mouse.targetIndex+"))",this).remove()});d("tr",this.dom.drag).height(d("tr:eq(0)",a.s.dt.nTHead).height());d("thead tr:gt(0)",this.dom.drag).remove();d("thead th:eq(0)",this.dom.drag).each(function(){this.style.width=d("th:eq("+a.s.mouse.targetIndex+")",a.s.dt.nTHead).width()+"px"});this.dom.drag.style.position="absolute";this.dom.drag.style.zIndex=1200;this.dom.drag.style.top="0px";this.dom.drag.style.left="0px";this.dom.drag.style.width= d("th:eq("+a.s.mouse.targetIndex+")",a.s.dt.nTHead).outerWidth()+"px";this.dom.pointer=h.createElement("div");this.dom.pointer.className="DTCR_pointer";this.dom.pointer.style.position="absolute";""===this.s.dt.oScroll.sX&&""===this.s.dt.oScroll.sY?(this.dom.pointer.style.top=d(this.s.dt.nTable).offset().top+"px",this.dom.pointer.style.height=d(this.s.dt.nTable).height()+"px"):(this.dom.pointer.style.top=d("div.dataTables_scroll",this.s.dt.nTableWrapper).offset().top+"px",this.dom.pointer.style.height= d("div.dataTables_scroll",this.s.dt.nTableWrapper).height()+"px");h.body.appendChild(this.dom.pointer);h.body.appendChild(this.dom.drag)},_fnDestroy:function(){for(var a=0,c=ColReorder.aoInstances.length;a<c;a++)if(ColReorder.aoInstances[a]===this){ColReorder.aoInstances.splice(a,1);break}d(this.s.dt.nTHead).find("*").unbind(".ColReorder");this.s=this.s.dt.oInstance._oPluginColReorder=null}};ColReorder.aoInstances=[];ColReorder.fnReset=function(a){for(var c=0,d=ColReorder.aoInstances.length;c<d;c++)ColReorder.aoInstances[c].s.dt.oInstance== a&&ColReorder.aoInstances[c].fnReset()};ColReorder.prototype.CLASS="ColReorder";ColReorder.VERSION="1.0.7";ColReorder.prototype.VERSION=ColReorder.VERSION;"function"==typeof d.fn.dataTable&&"function"==typeof d.fn.dataTableExt.fnVersionCheck&&d.fn.dataTableExt.fnVersionCheck("1.9.3")?d.fn.dataTableExt.aoFeatures.push({fnInit:function(a){var c=a.oInstance;"undefined"==typeof c._oPluginColReorder?c._oPluginColReorder=new ColReorder(a,"undefined"!=typeof a.oInit.oColReorder?a.oInit.oColReorder:{}):c.oApi._fnLog(a, 1,"ColReorder attempted to initialise twice. Ignoring second");return null},cFeature:"R",sFeature:"ColReorder"}):alert("Warning: ColReorder requires DataTables 1.9.3 or greater - www.datatables.net/download")})(jQuery,window,document);